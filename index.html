<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小瑪莉水果盤 (Little Mary Fruit Machine)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation; /* 防止雙擊縮放 */
        }
        .font-arcade {
            font-family: 'Press Start 2P', cursive;
        }
        /* 自訂霓虹燈光暈效果 */
        .neon-shadow-yellow {
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fef08a, 0 0 20px #fef08a, 0 0 25px #fef08a, 0 0 30px #fef08a, 0 0 35px #fef08a;
        }
        .neon-shadow-blue {
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #60a5fa, 0 0 20px #60a5fa, 0 0 25px #60a5fa, 0 0 30px #60a5fa, 0 0 35px #60a5fa;
        }
        .bet-button {
            transition: all 0.1s ease-in-out;
        }
        .bet-button:active {
            transform: scale(0.9);
        }
        /* 防止文字選取 */
        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
        }
    </style>
</head>
<body class="bg-gray-500 text-white flex items-center justify-center min-h-screen p-4 noselect">

    <!-- 主遊戲容器：移除 lg:items-start 以確保左右兩側在 lg 螢幕上同高 (stretch) -->
    <div class="w-full max-w-7xl mx-auto flex flex-col lg:flex-row lg:justify-center p-4 gap-6">

        <!-- 左側：遊戲盤面 -->
        <div class="flex-grow flex-shrink bg-gray-700 rounded-2xl shadow-2xl p-4 sm:p-6 border-4 border-gray-800/50">
            <!-- 標題 -->
            <header class="text-center mb-4">
                <h1 class="text-3xl sm:text-4xl font-bold text-yellow-300 font-arcade tracking-wider">小瑪莉</h1>
                <p class="text-blue-300 font-sans">Slot Mechine</p>
            </header>
            
            <!-- 遊戲盤面 -->
            <div id="game-board" class="grid-container mb-4">
                <!-- JS動態生成 -->
            </div>
        </div>

        <!-- 右側：資訊與下注區 (會自動拉伸至左側高度) -->
        <div class="flex-grow flex-shrink w-full lg:w-96 bg-gray-700 rounded-2xl shadow-2xl p-4 sm:p-6 border-4 border-gray-800/50 flex flex-col space-y-4">
            <!-- 遊戲資訊顯示區 -->
            <div class="grid grid-cols-2 gap-4 bg-black/50 p-3 rounded-lg text-center">
                <div>
                    <p class="text-sm text-gray-400">CREDITS</p>
                    <p id="credits-display" class="text-2xl font-bold text-green-400">1000</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">TOTAL BET</p>
                    <p id="total-bet-display" class="text-2xl font-bold text-red-400">0</p>
                </div>
                <div class="col-span-2 mt-2">
                     <p id="message-display" class="h-6 text-lg text-yellow-300 font-bold truncate">&nbsp;</p>
                </div>
            </div>

            <div class="bg-black/50 p-3 rounded-lg">
                <h2 class="text-center text-lg font-bold mb-3 text-blue-300">下注區</h2>
                <div id="betting-controls" class="grid grid-cols-3 sm:grid-cols-6 lg:grid-cols-3 gap-2">
                    <!-- JS動態生成 -->
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="flex space-x-4">
                <button id="clear-button" aria-label="清除所有賭注" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg text-xl shadow-lg transition duration-200 bet-button">清除</button>
                <button id="start-button" aria-label="開始轉動" class="w-1/2 bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-3 rounded-lg text-xl shadow-lg transition duration-200 bet-button">開始</button>
            </div>
        </div>

    </div>

    <script>
        const SYMBOLS = {
            apple:     { name: '蘋果', emoji: '🍎', payout: 2,  css: 'bg-red-500/80' },
            bell:      { name: '鈴鐺', emoji: '🔔', payout: 5,  css: 'bg-yellow-500/80' },
            watermelon:{ name: '西瓜', emoji: '🍉', payout: 10, css: 'bg-green-500/80' },
            star:      { name: '星星', emoji: '⭐', payout: 20, css: 'bg-blue-500/80' },
            seven:     { name: '７７', emoji: '７', payout: 40, css: 'bg-purple-500/80' },
            bar:       { name: 'BAR', emoji: '👑', payout: 100, css: 'bg-pink-500/80' }
        };

        // 盤面配置 (20個位置)
        const BOARD_LAYOUT = [
            'apple', 'bell', 'watermelon', 'star', 'apple', 'seven', 'bar',
            'bell', 'apple', 'watermelon', 'bell', 
            'apple', 'star', 'apple', 'seven', 'bell', 'apple',
            'watermelon', 'bell', 'apple'
        ];
        
        const GRID_MAP = [
            { r: 1, c: 1 }, { r: 1, c: 2 }, { r: 1, c: 3 }, { r: 1, c: 4 }, { r: 1, c: 5 }, { r: 1, c: 6 }, { r: 1, c: 7 },
            { r: 2, c: 7 }, { r: 3, c: 7 }, { r: 4, c: 7 }, { r: 5, c: 7 },
            { r: 5, c: 6 }, { r: 5, c: 5 }, { r: 5, c: 4 }, { r: 5, c: 3 }, { r: 5, c: 2 }, { r: 5, c: 1 },
            { r: 4, c: 1 }, { r: 3, c: 1 }, { r: 2, c: 1 }
        ];

        // --- 遊戲設定與常數 ---
        const MIN_SPIN_ROUNDS = 3; // 至少轉動的圈數
        const EXTRA_SPIN_RANGE = BOARD_LAYOUT.length; // 額外隨機步數的最大範圍
        const INITIAL_CREDITS = 1000; // 初始信用點數

        // 音效設定 (頻率, 類型, 持續時間)
        const SOUND_CONFIG = {
            BET:     { freq: 440, type: 'triangle', duration: 0.05 },
            CLEAR:   { freq: 330, type: 'triangle', duration: 0.05 },
            START_1: { freq: 261.63, type: 'sine', duration: 0.1 },
            START_2: { freq: 392.00, type: 'sine', duration: 0.1 },
            SPIN_TICK_BASE: 200, // 轉動音效的基礎頻率
            WIN_1:   { freq: 523.25, type: 'triangle', duration: 0.1 }, // C5
            WIN_2:   { freq: 659.25, type: 'triangle', duration: 0.1 }, // E5
            WIN_3:   { freq: 783.99, type: 'triangle', duration: 0.1 }, // G5
            WIN_4:   { freq: 1046.50, type: 'triangle', duration: 0.2 }, // C6
            LOSE:    { freq: 220, type: 'sawtooth', duration: 0.2 }
        };

        // 遊戲狀態
        let state = {
            credits: INITIAL_CREDITS,
            bets: {},
            totalBet: 0,
            isSpinning: false,
            currentLightIndex: 0
        };

        // DOM 元素
        const creditsDisplay = document.getElementById('credits-display');
        const totalBetDisplay = document.getElementById('total-bet-display');
        const messageDisplay = document.getElementById('message-display');
        const gameBoard = document.getElementById('game-board');
        const bettingControls = document.getElementById('betting-controls');
        const clearButton = document.getElementById('clear-button');
        const startButton = document.getElementById('start-button');
        
        let audioContext;
        let isAudioInitialized = false;

        // --- 音效處理 ---
        function initAudio() {
            if (isAudioInitialized) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                isAudioInitialized = true;
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
            }
        }

        function playSound(freq, type = 'sine', duration = 0.1) {
            if (!isAudioInitialized || !audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playWinSound() {
            const { WIN_1, WIN_2, WIN_3, WIN_4 } = SOUND_CONFIG;
            playSound(WIN_1.freq, WIN_1.type, WIN_1.duration);
            setTimeout(() => playSound(WIN_2.freq, WIN_2.type, WIN_2.duration), 100);
            setTimeout(() => playSound(WIN_3.freq, WIN_3.type, WIN_3.duration), 200);
            setTimeout(() => playSound(WIN_4.freq, WIN_4.type, WIN_4.duration), 300);
        }
        
        // --- 遊戲初始化 ---
        function init() {
            // 初始化賭注
            for (const key in SYMBOLS) {
                state.bets[key] = 0;
            }
            
            createGameBoard();
            createBettingControls();
            
            updateUI();

            clearButton.addEventListener('click', handleClear);
            startButton.addEventListener('click', handleStart);
        }

        // --- 建立遊戲介面 ---

        function createGameBoard() {
            gameBoard.innerHTML = '';
            BOARD_LAYOUT.forEach((symbolKey, index) => {
                if(symbolKey) {
                    const symbol = SYMBOLS[symbolKey];
                    const cell = document.createElement('div');
                    cell.id = `cell-${index}`;
                    cell.className = `board-cell flex flex-col items-center justify-center rounded-lg p-1 text-center transition-all duration-100 ${symbol.css}`;
                    cell.style.gridRow = GRID_MAP[index].r;
                    cell.style.gridColumn = GRID_MAP[index].c;
                    cell.innerHTML = `
                        <div class="text-2xl sm:text-3xl">${symbol.emoji}</div>
                        <div class="text-xs font-bold">${symbol.name}</div>
                        <div class="text-xs font-bold">x${symbol.payout}</div>
                    `;
                    gameBoard.appendChild(cell);
                }
            });
            // 中央Logo
            const logoCell = document.createElement('div');
            logoCell.className = "flex items-center justify-center bg-black/70 rounded-lg";
            logoCell.style.gridArea = "2 / 2 / 5 / 7";
            logoCell.innerHTML = `<div class="font-arcade text-yellow-300 text-3xl sm:text-5xl tracking-widest">BAR</div>`;
            gameBoard.appendChild(logoCell);
        }

        function createBettingControls() {
            bettingControls.innerHTML = '';
            for (const key in SYMBOLS) {
                const symbol = SYMBOLS[key];
                const control = document.createElement('div');
                control.className = `flex flex-col items-center justify-center bg-gray-700 p-2 rounded-lg`;
                control.innerHTML = `
                    <div class="flex items-center justify-center mb-1">
                        <span class="text-xl">${symbol.emoji}</span>
                        <span class="ml-1 text-xs font-bold">${symbol.name}</span>
                    </div>
                    <!-- 賭注數字方框化，添加底色與邊框 -->
                    <div id="bet-${key}" class="text-lg font-bold text-yellow-300 bg-gray-900/70 border border-yellow-400 rounded-md px-2 py-0.5 my-1 w-full text-center">0</div>
                    <!-- 將 flex-col space-y-1 更改為 flex space-x-1，並使用 flex-1 讓按鈕平均分配空間 -->
                    <div class="flex w-full mt-1 space-x-1">
                        <button data-symbol="${key}" data-amount="1" aria-label="增加 ${symbol.name} 賭注" class="bet-change-button flex-1 bg-blue-600 rounded-md font-bold text-base py-0.5 bet-button">+</button>
                        <button data-symbol="${key}" data-amount="-1" aria-label="減少 ${symbol.name} 賭注" class="bet-change-button flex-1 bg-red-600 rounded-md font-bold text-base py-0.5 bet-button">-</button>
                    </div>
                `;
                bettingControls.appendChild(control);
            }

            document.querySelectorAll('.bet-change-button').forEach(button => {
                button.addEventListener('click', handleBetChange);
            });
        }
        
        // --- 更新UI ---
        function updateUI() {
            creditsDisplay.textContent = state.credits;
            state.totalBet = Object.values(state.bets).reduce((sum, val) => sum + val, 0);
            totalBetDisplay.textContent = state.totalBet;

            for (const key in state.bets) {
                const betDisplay = document.getElementById(`bet-${key}`);
                if (betDisplay) {
                    betDisplay.textContent = state.bets[key];
                }
            }
        }

        // --- 事件處理 ---
        function handleBetChange(event) {
            if (state.isSpinning) return;
            initAudio(); // 首次互動時啟用音效
            const { freq, type, duration } = SOUND_CONFIG.BET;
            playSound(freq, type, duration);
            const { symbol, amount } = event.target.dataset;
            const change = parseInt(amount, 10);
            const newBet = state.bets[symbol] + change;

            if (newBet >= 0) {
                 if (change > 0 && state.totalBet + change > state.credits) {
                    showMessage('信用點數不足!');
                    return;
                }
                state.bets[symbol] = newBet;
                updateUI();
            }
        }
        
        function handleClear() {
            if (state.isSpinning) return;
            initAudio();
            const { freq, type, duration } = SOUND_CONFIG.CLEAR;
            playSound(freq, type, duration);
            for (const key in state.bets) {
                state.bets[key] = 0;
            }
            updateUI();
            showMessage('賭注已清除');
        }

        function handleStart() {
            if (state.isSpinning) return;
            if (state.totalBet === 0) {
                showMessage('請先下注!');
                return;
            }
            if (state.totalBet > state.credits) {
                showMessage('信用點數不足!');
                return;
            }
            
            initAudio();
            const { START_1, START_2 } = SOUND_CONFIG;
            playSound(START_1.freq, START_1.type, START_1.duration);
            setTimeout(() => playSound(START_2.freq, START_2.type, START_2.duration), 100);

            state.isSpinning = true;
            state.credits -= state.totalBet;
            updateUI();
            showMessage('轉動中...');
            
            // 禁用按鈕
            startButton.disabled = true;
            startButton.classList.replace('bg-green-500', 'bg-gray-500');
            startButton.classList.remove('hover:bg-green-600');
            clearButton.disabled = true;

            spin();
        }

        function showMessage(msg) {
            messageDisplay.textContent = msg;
        }

        // --- 遊戲核心邏輯 ---
        function spin() {
            // --- 計算轉動總步數 ---
            // 為了讓玩家感覺每次轉動都是隨機的，我們設定一個最小圈數再加上一個隨機步數。
            const minSteps = MIN_SPIN_ROUNDS * BOARD_LAYOUT.length;
            const randomExtraSteps = Math.floor(Math.random() * EXTRA_SPIN_RANGE);
            const totalSteps = minSteps + randomExtraSteps;
            
            let currentStep = 0;
            let interval = 50; // 初始速度 (毫秒)

            // --- 使用遞迴的 setTimeout 來建立一個穩定且可變速的計時器 ---
            // 相比 setInterval，遞迴的 setTimeout 能更好地控制每次執行的間隔，特別是在需要動態改變速度時。
            function step() {
                // 1. 清除上一個燈光效果
                const prevCell = document.getElementById(`cell-${state.currentLightIndex}`);
                if (prevCell) {
                    prevCell.classList.remove('neon-shadow-yellow');
                }
                
                // 2. 計算並移動到下一個位置
                state.currentLightIndex = (state.currentLightIndex + 1) % BOARD_LAYOUT.length;
                
                // 3. 點亮新的燈光
                const currentCell = document.getElementById(`cell-${state.currentLightIndex}`);
                if (currentCell) {
                    currentCell.classList.add('neon-shadow-yellow');
                }

                // 4. 播放轉動音效，頻率有輕微變化以增加動感
                const tickSoundFreq = SOUND_CONFIG.SPIN_TICK_BASE + (currentStep % 10) * 10;
                playSound(tickSoundFreq, 'square', 0.05);
                
                currentStep++;
                
                // 5. 檢查是否結束轉動
                if (currentStep >= totalSteps) {
                    endSpin(); // 呼叫結束處理函式
                    return;    // 結束遞迴，停止轉動
                }

                // 6. 減速邏輯：在接近終點時，逐步增加間隔時間，製造減速效果
                if (currentStep > totalSteps - 10) {
                    interval += 30; // 最後10步，大幅減速
                } else if (currentStep > totalSteps - 20) {
                    interval += 10; // 接近終點的20步內，開始減速
                }
                
                // 7. 安排下一次 step 的執行
                setTimeout(step, interval);
            }

            // 啟動轉動程序
            step();
        }

        function endSpin() {
            const winningIndex = state.currentLightIndex;
            const winningSymbolKey = BOARD_LAYOUT[winningIndex];
            const winningSymbolData = SYMBOLS[winningSymbolKey];
            const betOnSymbol = state.bets[winningSymbolKey];
            let winnings = 0;

            if (betOnSymbol > 0) {
                winnings = betOnSymbol * winningSymbolData.payout;
                state.credits += winnings;
            }

            setTimeout(() => {
                if (winnings > 0) {
                    playWinSound();
                    showMessage(`恭喜! 贏得 ${winnings} 點!`);
                } else {
                    const { freq, type, duration } = SOUND_CONFIG.LOSE;
                    playSound(freq, type, duration);
                    showMessage('再接再厲!');
                }

                const finalCell = document.getElementById(`cell-${winningIndex}`);
                if (finalCell) {
                    finalCell.classList.replace('neon-shadow-yellow', 'neon-shadow-blue');
                }
                
                // 重新啟用按鈕
                state.isSpinning = false;
                startButton.disabled = false;
                startButton.classList.replace('bg-gray-500', 'bg-green-500');
                startButton.classList.add('hover:bg-green-600');
                clearButton.disabled = false;

                updateUI();
                
                // 2秒後清除藍色光暈
                setTimeout(() => {
                     if (finalCell) finalCell.classList.remove('neon-shadow-blue');
                }, 2000);

            }, 500);
        }
        
        // --- 啟動遊戲 ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
