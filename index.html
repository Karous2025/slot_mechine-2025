<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç‘ªè‰æ°´æœç›¤ (Little Mary Fruit Machine)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation; /* é˜²æ­¢é›™æ“Šç¸®æ”¾ */
        }
        .font-arcade {
            font-family: 'Press Start 2P', cursive;
        }
        /* è‡ªè¨‚éœ“è™¹ç‡ˆå…‰æšˆæ•ˆæœ */
        .neon-shadow-yellow {
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #fef08a, 0 0 20px #fef08a, 0 0 25px #fef08a, 0 0 30px #fef08a, 0 0 35px #fef08a;
        }
        .neon-shadow-blue {
            box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #60a5fa, 0 0 20px #60a5fa, 0 0 25px #60a5fa, 0 0 30px #60a5fa, 0 0 35px #60a5fa;
        }
        .bet-button {
            transition: all 0.1s ease-in-out;
        }
        .bet-button:active {
            transform: scale(0.9);
        }
        /* é˜²æ­¢æ–‡å­—é¸å– */
        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
        }
    </style>
</head>
<body class="bg-gray-500 text-white flex items-center justify-center min-h-screen p-4 noselect">

    <!-- ä¸»éŠæˆ²å®¹å™¨ï¼šç§»é™¤ lg:items-start ä»¥ç¢ºä¿å·¦å³å…©å´åœ¨ lg è¢å¹•ä¸ŠåŒé«˜ (stretch) -->
    <div class="w-full max-w-7xl mx-auto flex flex-col lg:flex-row lg:justify-center p-4 gap-6">

        <!-- å·¦å´ï¼šéŠæˆ²ç›¤é¢ -->
        <div class="flex-grow flex-shrink bg-gray-700 rounded-2xl shadow-2xl p-4 sm:p-6 border-4 border-gray-800/50">
            <!-- æ¨™é¡Œ -->
            <header class="text-center mb-4">
                <h1 class="text-3xl sm:text-4xl font-bold text-yellow-300 font-arcade tracking-wider">å°ç‘ªè‰</h1>
                <p class="text-blue-300 font-sans">Slot Mechine</p>
            </header>
            
            <!-- éŠæˆ²ç›¤é¢ -->
            <div id="game-board" class="grid-container mb-4">
                <!-- JSå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³å´ï¼šè³‡è¨Šèˆ‡ä¸‹æ³¨å€ (æœƒè‡ªå‹•æ‹‰ä¼¸è‡³å·¦å´é«˜åº¦) -->
        <div class="flex-grow flex-shrink w-full lg:w-96 bg-gray-700 rounded-2xl shadow-2xl p-4 sm:p-6 border-4 border-gray-800/50 flex flex-col space-y-4">
            <!-- éŠæˆ²è³‡è¨Šé¡¯ç¤ºå€ -->
            <div class="grid grid-cols-2 gap-4 bg-black/50 p-3 rounded-lg text-center">
                <div>
                    <p class="text-sm text-gray-400">CREDITS</p>
                    <p id="credits-display" class="text-2xl font-bold text-green-400">1000</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">TOTAL BET</p>
                    <p id="total-bet-display" class="text-2xl font-bold text-red-400">0</p>
                </div>
                <div class="col-span-2 mt-2">
                     <p id="message-display" class="h-6 text-lg text-yellow-300 font-bold truncate">&nbsp;</p>
                </div>
            </div>

            <div class="bg-black/50 p-3 rounded-lg">
                <h2 class="text-center text-lg font-bold mb-3 text-blue-300">ä¸‹æ³¨å€</h2>
                <div id="betting-controls" class="grid grid-cols-3 sm:grid-cols-6 lg:grid-cols-3 gap-2">
                    <!-- JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex space-x-4">
                <button id="clear-button" aria-label="æ¸…é™¤æ‰€æœ‰è³­æ³¨" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg text-xl shadow-lg transition duration-200 bet-button">æ¸…é™¤</button>
                <button id="start-button" aria-label="é–‹å§‹è½‰å‹•" class="w-1/2 bg-green-500 hover:bg-green-600 text-gray-900 font-bold py-3 rounded-lg text-xl shadow-lg transition duration-200 bet-button">é–‹å§‹</button>
            </div>
        </div>

    </div>

    <script>
        const SYMBOLS = {
            apple:     { name: 'è˜‹æœ', emoji: 'ğŸ', payout: 2,  css: 'bg-red-500/80' },
            bell:      { name: 'éˆ´éº', emoji: 'ğŸ””', payout: 5,  css: 'bg-yellow-500/80' },
            watermelon:{ name: 'è¥¿ç“œ', emoji: 'ğŸ‰', payout: 10, css: 'bg-green-500/80' },
            star:      { name: 'æ˜Ÿæ˜Ÿ', emoji: 'â­', payout: 20, css: 'bg-blue-500/80' },
            seven:     { name: 'ï¼—ï¼—', emoji: 'ï¼—', payout: 40, css: 'bg-purple-500/80' },
            bar:       { name: 'BAR', emoji: 'ğŸ‘‘', payout: 100, css: 'bg-pink-500/80' }
        };

        // ç›¤é¢é…ç½® (20å€‹ä½ç½®)
        const BOARD_LAYOUT = [
            'apple', 'bell', 'watermelon', 'star', 'apple', 'seven', 'bar',
            'bell', 'apple', 'watermelon', 'bell', 
            'apple', 'star', 'apple', 'seven', 'bell', 'apple',
            'watermelon', 'bell', 'apple'
        ];
        
        const GRID_MAP = [
            { r: 1, c: 1 }, { r: 1, c: 2 }, { r: 1, c: 3 }, { r: 1, c: 4 }, { r: 1, c: 5 }, { r: 1, c: 6 }, { r: 1, c: 7 },
            { r: 2, c: 7 }, { r: 3, c: 7 }, { r: 4, c: 7 }, { r: 5, c: 7 },
            { r: 5, c: 6 }, { r: 5, c: 5 }, { r: 5, c: 4 }, { r: 5, c: 3 }, { r: 5, c: 2 }, { r: 5, c: 1 },
            { r: 4, c: 1 }, { r: 3, c: 1 }, { r: 2, c: 1 }
        ];

        // --- éŠæˆ²è¨­å®šèˆ‡å¸¸æ•¸ ---
        const MIN_SPIN_ROUNDS = 3; // è‡³å°‘è½‰å‹•çš„åœˆæ•¸
        const EXTRA_SPIN_RANGE = BOARD_LAYOUT.length; // é¡å¤–éš¨æ©Ÿæ­¥æ•¸çš„æœ€å¤§ç¯„åœ
        const INITIAL_CREDITS = 1000; // åˆå§‹ä¿¡ç”¨é»æ•¸

        // éŸ³æ•ˆè¨­å®š (é »ç‡, é¡å‹, æŒçºŒæ™‚é–“)
        const SOUND_CONFIG = {
            BET:     { freq: 440, type: 'triangle', duration: 0.05 },
            CLEAR:   { freq: 330, type: 'triangle', duration: 0.05 },
            START_1: { freq: 261.63, type: 'sine', duration: 0.1 },
            START_2: { freq: 392.00, type: 'sine', duration: 0.1 },
            SPIN_TICK_BASE: 200, // è½‰å‹•éŸ³æ•ˆçš„åŸºç¤é »ç‡
            WIN_1:   { freq: 523.25, type: 'triangle', duration: 0.1 }, // C5
            WIN_2:   { freq: 659.25, type: 'triangle', duration: 0.1 }, // E5
            WIN_3:   { freq: 783.99, type: 'triangle', duration: 0.1 }, // G5
            WIN_4:   { freq: 1046.50, type: 'triangle', duration: 0.2 }, // C6
            LOSE:    { freq: 220, type: 'sawtooth', duration: 0.2 }
        };

        // éŠæˆ²ç‹€æ…‹
        let state = {
            credits: INITIAL_CREDITS,
            bets: {},
            totalBet: 0,
            isSpinning: false,
            currentLightIndex: 0
        };

        // DOM å…ƒç´ 
        const creditsDisplay = document.getElementById('credits-display');
        const totalBetDisplay = document.getElementById('total-bet-display');
        const messageDisplay = document.getElementById('message-display');
        const gameBoard = document.getElementById('game-board');
        const bettingControls = document.getElementById('betting-controls');
        const clearButton = document.getElementById('clear-button');
        const startButton = document.getElementById('start-button');
        
        let audioContext;
        let isAudioInitialized = false;

        // --- éŸ³æ•ˆè™•ç† ---
        function initAudio() {
            if (isAudioInitialized) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                isAudioInitialized = true;
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
            }
        }

        function playSound(freq, type = 'sine', duration = 0.1) {
            if (!isAudioInitialized || !audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playWinSound() {
            const { WIN_1, WIN_2, WIN_3, WIN_4 } = SOUND_CONFIG;
            playSound(WIN_1.freq, WIN_1.type, WIN_1.duration);
            setTimeout(() => playSound(WIN_2.freq, WIN_2.type, WIN_2.duration), 100);
            setTimeout(() => playSound(WIN_3.freq, WIN_3.type, WIN_3.duration), 200);
            setTimeout(() => playSound(WIN_4.freq, WIN_4.type, WIN_4.duration), 300);
        }
        
        // --- éŠæˆ²åˆå§‹åŒ– ---
        function init() {
            // åˆå§‹åŒ–è³­æ³¨
            for (const key in SYMBOLS) {
                state.bets[key] = 0;
            }
            
            createGameBoard();
            createBettingControls();
            
            updateUI();

            clearButton.addEventListener('click', handleClear);
            startButton.addEventListener('click', handleStart);
        }

        // --- å»ºç«‹éŠæˆ²ä»‹é¢ ---

        function createGameBoard() {
            gameBoard.innerHTML = '';
            BOARD_LAYOUT.forEach((symbolKey, index) => {
                if(symbolKey) {
                    const symbol = SYMBOLS[symbolKey];
                    const cell = document.createElement('div');
                    cell.id = `cell-${index}`;
                    cell.className = `board-cell flex flex-col items-center justify-center rounded-lg p-1 text-center transition-all duration-100 ${symbol.css}`;
                    cell.style.gridRow = GRID_MAP[index].r;
                    cell.style.gridColumn = GRID_MAP[index].c;
                    cell.innerHTML = `
                        <div class="text-2xl sm:text-3xl">${symbol.emoji}</div>
                        <div class="text-xs font-bold">${symbol.name}</div>
                        <div class="text-xs font-bold">x${symbol.payout}</div>
                    `;
                    gameBoard.appendChild(cell);
                }
            });
            // ä¸­å¤®Logo
            const logoCell = document.createElement('div');
            logoCell.className = "flex items-center justify-center bg-black/70 rounded-lg";
            logoCell.style.gridArea = "2 / 2 / 5 / 7";
            logoCell.innerHTML = `<div class="font-arcade text-yellow-300 text-3xl sm:text-5xl tracking-widest">BAR</div>`;
            gameBoard.appendChild(logoCell);
        }

        function createBettingControls() {
            bettingControls.innerHTML = '';
            for (const key in SYMBOLS) {
                const symbol = SYMBOLS[key];
                const control = document.createElement('div');
                control.className = `flex flex-col items-center justify-center bg-gray-700 p-2 rounded-lg`;
                control.innerHTML = `
                    <div class="flex items-center justify-center mb-1">
                        <span class="text-xl">${symbol.emoji}</span>
                        <span class="ml-1 text-xs font-bold">${symbol.name}</span>
                    </div>
                    <!-- è³­æ³¨æ•¸å­—æ–¹æ¡†åŒ–ï¼Œæ·»åŠ åº•è‰²èˆ‡é‚Šæ¡† -->
                    <div id="bet-${key}" class="text-lg font-bold text-yellow-300 bg-gray-900/70 border border-yellow-400 rounded-md px-2 py-0.5 my-1 w-full text-center">0</div>
                    <!-- å°‡ flex-col space-y-1 æ›´æ”¹ç‚º flex space-x-1ï¼Œä¸¦ä½¿ç”¨ flex-1 è®“æŒ‰éˆ•å¹³å‡åˆ†é…ç©ºé–“ -->
                    <div class="flex w-full mt-1 space-x-1">
                        <button data-symbol="${key}" data-amount="1" aria-label="å¢åŠ  ${symbol.name} è³­æ³¨" class="bet-change-button flex-1 bg-blue-600 rounded-md font-bold text-base py-0.5 bet-button">+</button>
                        <button data-symbol="${key}" data-amount="-1" aria-label="æ¸›å°‘ ${symbol.name} è³­æ³¨" class="bet-change-button flex-1 bg-red-600 rounded-md font-bold text-base py-0.5 bet-button">-</button>
                    </div>
                `;
                bettingControls.appendChild(control);
            }

            document.querySelectorAll('.bet-change-button').forEach(button => {
                button.addEventListener('click', handleBetChange);
            });
        }
        
        // --- æ›´æ–°UI ---
        function updateUI() {
            creditsDisplay.textContent = state.credits;
            state.totalBet = Object.values(state.bets).reduce((sum, val) => sum + val, 0);
            totalBetDisplay.textContent = state.totalBet;

            for (const key in state.bets) {
                const betDisplay = document.getElementById(`bet-${key}`);
                if (betDisplay) {
                    betDisplay.textContent = state.bets[key];
                }
            }
        }

        // --- äº‹ä»¶è™•ç† ---
        function handleBetChange(event) {
            if (state.isSpinning) return;
            initAudio(); // é¦–æ¬¡äº’å‹•æ™‚å•Ÿç”¨éŸ³æ•ˆ
            const { freq, type, duration } = SOUND_CONFIG.BET;
            playSound(freq, type, duration);
            const { symbol, amount } = event.target.dataset;
            const change = parseInt(amount, 10);
            const newBet = state.bets[symbol] + change;

            if (newBet >= 0) {
                 if (change > 0 && state.totalBet + change > state.credits) {
                    showMessage('ä¿¡ç”¨é»æ•¸ä¸è¶³!');
                    return;
                }
                state.bets[symbol] = newBet;
                updateUI();
            }
        }
        
        function handleClear() {
            if (state.isSpinning) return;
            initAudio();
            const { freq, type, duration } = SOUND_CONFIG.CLEAR;
            playSound(freq, type, duration);
            for (const key in state.bets) {
                state.bets[key] = 0;
            }
            updateUI();
            showMessage('è³­æ³¨å·²æ¸…é™¤');
        }

        function handleStart() {
            if (state.isSpinning) return;
            if (state.totalBet === 0) {
                showMessage('è«‹å…ˆä¸‹æ³¨!');
                return;
            }
            if (state.totalBet > state.credits) {
                showMessage('ä¿¡ç”¨é»æ•¸ä¸è¶³!');
                return;
            }
            
            initAudio();
            const { START_1, START_2 } = SOUND_CONFIG;
            playSound(START_1.freq, START_1.type, START_1.duration);
            setTimeout(() => playSound(START_2.freq, START_2.type, START_2.duration), 100);

            state.isSpinning = true;
            state.credits -= state.totalBet;
            updateUI();
            showMessage('è½‰å‹•ä¸­...');
            
            // ç¦ç”¨æŒ‰éˆ•
            startButton.disabled = true;
            startButton.classList.replace('bg-green-500', 'bg-gray-500');
            startButton.classList.remove('hover:bg-green-600');
            clearButton.disabled = true;

            spin();
        }

        function showMessage(msg) {
            messageDisplay.textContent = msg;
        }

        // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
        function spin() {
            // --- è¨ˆç®—è½‰å‹•ç¸½æ­¥æ•¸ ---
            // ç‚ºäº†è®“ç©å®¶æ„Ÿè¦ºæ¯æ¬¡è½‰å‹•éƒ½æ˜¯éš¨æ©Ÿçš„ï¼Œæˆ‘å€‘è¨­å®šä¸€å€‹æœ€å°åœˆæ•¸å†åŠ ä¸Šä¸€å€‹éš¨æ©Ÿæ­¥æ•¸ã€‚
            const minSteps = MIN_SPIN_ROUNDS * BOARD_LAYOUT.length;
            const randomExtraSteps = Math.floor(Math.random() * EXTRA_SPIN_RANGE);
            const totalSteps = minSteps + randomExtraSteps;
            
            let currentStep = 0;
            let interval = 50; // åˆå§‹é€Ÿåº¦ (æ¯«ç§’)

            // --- ä½¿ç”¨éè¿´çš„ setTimeout ä¾†å»ºç«‹ä¸€å€‹ç©©å®šä¸”å¯è®Šé€Ÿçš„è¨ˆæ™‚å™¨ ---
            // ç›¸æ¯” setIntervalï¼Œéè¿´çš„ setTimeout èƒ½æ›´å¥½åœ°æ§åˆ¶æ¯æ¬¡åŸ·è¡Œçš„é–“éš”ï¼Œç‰¹åˆ¥æ˜¯åœ¨éœ€è¦å‹•æ…‹æ”¹è®Šé€Ÿåº¦æ™‚ã€‚
            function step() {
                // 1. æ¸…é™¤ä¸Šä¸€å€‹ç‡ˆå…‰æ•ˆæœ
                const prevCell = document.getElementById(`cell-${state.currentLightIndex}`);
                if (prevCell) {
                    prevCell.classList.remove('neon-shadow-yellow');
                }
                
                // 2. è¨ˆç®—ä¸¦ç§»å‹•åˆ°ä¸‹ä¸€å€‹ä½ç½®
                state.currentLightIndex = (state.currentLightIndex + 1) % BOARD_LAYOUT.length;
                
                // 3. é»äº®æ–°çš„ç‡ˆå…‰
                const currentCell = document.getElementById(`cell-${state.currentLightIndex}`);
                if (currentCell) {
                    currentCell.classList.add('neon-shadow-yellow');
                }

                // 4. æ’­æ”¾è½‰å‹•éŸ³æ•ˆï¼Œé »ç‡æœ‰è¼•å¾®è®ŠåŒ–ä»¥å¢åŠ å‹•æ„Ÿ
                const tickSoundFreq = SOUND_CONFIG.SPIN_TICK_BASE + (currentStep % 10) * 10;
                playSound(tickSoundFreq, 'square', 0.05);
                
                currentStep++;
                
                // 5. æª¢æŸ¥æ˜¯å¦çµæŸè½‰å‹•
                if (currentStep >= totalSteps) {
                    endSpin(); // å‘¼å«çµæŸè™•ç†å‡½å¼
                    return;    // çµæŸéè¿´ï¼Œåœæ­¢è½‰å‹•
                }

                // 6. æ¸›é€Ÿé‚è¼¯ï¼šåœ¨æ¥è¿‘çµ‚é»æ™‚ï¼Œé€æ­¥å¢åŠ é–“éš”æ™‚é–“ï¼Œè£½é€ æ¸›é€Ÿæ•ˆæœ
                if (currentStep > totalSteps - 10) {
                    interval += 30; // æœ€å¾Œ10æ­¥ï¼Œå¤§å¹…æ¸›é€Ÿ
                } else if (currentStep > totalSteps - 20) {
                    interval += 10; // æ¥è¿‘çµ‚é»çš„20æ­¥å…§ï¼Œé–‹å§‹æ¸›é€Ÿ
                }
                
                // 7. å®‰æ’ä¸‹ä¸€æ¬¡ step çš„åŸ·è¡Œ
                setTimeout(step, interval);
            }

            // å•Ÿå‹•è½‰å‹•ç¨‹åº
            step();
        }

        function endSpin() {
            const winningIndex = state.currentLightIndex;
            const winningSymbolKey = BOARD_LAYOUT[winningIndex];
            const winningSymbolData = SYMBOLS[winningSymbolKey];
            const betOnSymbol = state.bets[winningSymbolKey];
            let winnings = 0;

            if (betOnSymbol > 0) {
                winnings = betOnSymbol * winningSymbolData.payout;
                state.credits += winnings;
            }

            setTimeout(() => {
                if (winnings > 0) {
                    playWinSound();
                    showMessage(`æ­å–œ! è´å¾— ${winnings} é»!`);
                } else {
                    const { freq, type, duration } = SOUND_CONFIG.LOSE;
                    playSound(freq, type, duration);
                    showMessage('å†æ¥å†å²!');
                }

                const finalCell = document.getElementById(`cell-${winningIndex}`);
                if (finalCell) {
                    finalCell.classList.replace('neon-shadow-yellow', 'neon-shadow-blue');
                }
                
                // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
                state.isSpinning = false;
                startButton.disabled = false;
                startButton.classList.replace('bg-gray-500', 'bg-green-500');
                startButton.classList.add('hover:bg-green-600');
                clearButton.disabled = false;

                updateUI();
                
                // 2ç§’å¾Œæ¸…é™¤è—è‰²å…‰æšˆ
                setTimeout(() => {
                     if (finalCell) finalCell.classList.remove('neon-shadow-blue');
                }, 2000);

            }, 500);
        }
        
        // --- å•Ÿå‹•éŠæˆ² ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
